---
phase: 01-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - include/cels-ncurses/tui_color.h
  - src/graphics/tui_color.c
  - CMakeLists.txt
autonomous: true

must_haves:
  truths:
    - "Developer can create a TUI_Color from RGB values and it eagerly resolves to the nearest xterm-256 color index"
    - "Developer can create a TUI_Style with fg/bg colors and attribute flags (bold, dim, underline, reverse)"
    - "TUI_COLOR_DEFAULT exists with internal index -1 for terminal default colors"
    - "tui_style_apply atomically sets attributes and color pair on a WINDOW via wattr_set (no attron/attroff)"
    - "Color pairs are allocated dynamically via alloc_pair with automatic dedup and LRU eviction"
    - "Default fg+bg (-1, -1) uses pair 0 directly without calling alloc_pair"
  artifacts:
    - path: "include/cels-ncurses/tui_color.h"
      provides: "TUI_Color, TUI_Style, TUI_ATTR_* flags, tui_color_rgb, TUI_COLOR_DEFAULT, tui_style_apply declaration"
      contains: "typedef struct TUI_Color"
    - path: "src/graphics/tui_color.c"
      provides: "rgb_to_nearest_256 implementation, tui_style_apply implementation with alloc_pair"
      contains: "alloc_pair"
    - path: "CMakeLists.txt"
      provides: "tui_color.c added to INTERFACE target_sources"
      contains: "tui_color.c"
  key_links:
    - from: "src/graphics/tui_color.c"
      to: "ncurses alloc_pair"
      via: "tui_style_apply calls alloc_pair for non-default color combos"
      pattern: "alloc_pair"
    - from: "src/graphics/tui_color.c"
      to: "ncurses wattr_set"
      via: "tui_style_apply sets attrs+pair atomically"
      pattern: "wattr_set"
    - from: "include/cels-ncurses/tui_color.h"
      to: "src/graphics/tui_color.c"
      via: "header declares extern functions, .c implements them"
      pattern: "extern.*tui_color_rgb|extern.*tui_style_apply"
---

<objective>
Create the color and style system: TUI_Color (RGB with eager nearest-256 mapping), TUI_Style (fg/bg/attrs), attribute flags, and the tui_style_apply function that uses alloc_pair + wattr_set for atomic attribute application.

Purpose: Replaces the hardcoded CP_* color pair constants and attron/attroff pattern. All drawing code in Phase 2+ will use TUI_Style to set colors and attributes on any WINDOW, with the color pair pool managed invisibly by ncurses alloc_pair.

Output: `include/cels-ncurses/tui_color.h` (type definitions, macros, declarations) and `src/graphics/tui_color.c` (implementation).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/codebase/CONVENTIONS.md

# Existing code for style reference and CMake pattern
@include/cels-ncurses/tui_renderer.h
@src/window/tui_window.c
@CMakeLists.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tui_color.h with TUI_Color, TUI_Style, attribute flags, and function declarations</name>
  <files>include/cels-ncurses/tui_color.h</files>
  <action>
Create `include/cels-ncurses/tui_color.h` with:

**Header documentation block** following project convention:
- Purpose: Color types, style struct, and attribute flags for the TUI graphics API
- Usage example showing tui_color_rgb, TUI_COLOR_DEFAULT, TUI_Style creation, tui_style_apply

**Include guard:** `CELS_NCURSES_TUI_COLOR_H`

**Includes:** `<ncurses.h>`, `<stdint.h>`

**Section: Color Type**
```c
typedef struct TUI_Color {
    int index;  /* -1 = terminal default, 0-255 = xterm-256 color index */
} TUI_Color;

#define TUI_COLOR_DEFAULT ((TUI_Color){ .index = -1 })
```

**Section: Attribute Flags**
```c
#define TUI_ATTR_NORMAL    0x00
#define TUI_ATTR_BOLD      0x01
#define TUI_ATTR_DIM       0x02
#define TUI_ATTR_UNDERLINE 0x04
#define TUI_ATTR_REVERSE   0x08
```

**Section: Style Type**
```c
typedef struct TUI_Style {
    TUI_Color fg;
    TUI_Color bg;
    uint32_t attrs;
} TUI_Style;
```

**Section: Function Declarations**
```c
/* Create a color from RGB values (0-255 per channel).
 * Eagerly maps to nearest xterm-256 color index at creation time. */
extern TUI_Color tui_color_rgb(uint8_t r, uint8_t g, uint8_t b);

/* Apply a style atomically to an ncurses WINDOW.
 * Uses alloc_pair for color pair resolution and wattr_set for
 * atomic attribute application. Never uses attron/attroff. */
extern void tui_style_apply(WINDOW* win, TUI_Style style);
```

Use `/* ... */` comments only, 4-space indent, `=` section dividers per project conventions.
  </action>
  <verify>
Header should parse cleanly when included:
```bash
echo '#include <ncurses.h>
#include "cels-ncurses/tui_color.h"
int main(void) {
    TUI_Color c = tui_color_rgb(255, 0, 0);
    TUI_Color d = TUI_COLOR_DEFAULT;
    TUI_Style s = { .fg = c, .bg = d, .attrs = TUI_ATTR_BOLD | TUI_ATTR_UNDERLINE };
    (void)s;
    return 0;
}' > /tmp/test_tui_color_h.c
gcc -std=c99 -Wall -Wextra -pedantic -I include $(pkg-config --cflags ncursesw) -c -o /tmp/test_tui_color_h.o /tmp/test_tui_color_h.c && echo "PASS" || echo "FAIL"
```
  </verify>
  <done>
- tui_color.h exists with TUI_Color, TUI_Style, TUI_ATTR_* macros
- TUI_COLOR_DEFAULT has .index = -1
- tui_color_rgb and tui_style_apply are declared as extern
- Header compiles cleanly as C99 with -Wall -Wextra -pedantic
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement tui_color.c with RGB mapping, attribute conversion, and style application</name>
  <files>src/graphics/tui_color.c, CMakeLists.txt</files>
  <action>
**Create directory** `src/graphics/` if it does not exist.

**Create `src/graphics/tui_color.c`** with:

**File header comment** following project convention:
- Purpose: Color pool implementation (alloc_pair wrapper) and RGB-to-nearest-256 mapping
- Note that this is an INTERFACE library file -- compiles in consumer's context

**POSIX feature test macros** at the top (before includes):
```c
#define _POSIX_C_SOURCE 199309L
#define _DEFAULT_SOURCE
```

**Includes:** `"cels-ncurses/tui_color.h"`, `<ncurses.h>`, `<stdint.h>`

**Section: xterm-256 Color Mapping**

Implement `rgb_to_nearest_256` as a `static` function using the exact algorithm from RESEARCH.md:
- CUBE_LEVELS[6] = { 0, 95, 135, 175, 215, 255 }
- nearest_cube_index: threshold-based mapping (if val < 48 return 0, < 115 return 1, < 155 return 2, < 195 return 3, < 235 return 4, else 5)
- Compare squared Euclidean distance between color cube match and greyscale ramp match
- Return whichever index (cube 16-231 or grey 232-255) is closer

**Section: Public API**

Implement `tui_color_rgb`:
```c
TUI_Color tui_color_rgb(uint8_t r, uint8_t g, uint8_t b) {
    return (TUI_Color){ .index = rgb_to_nearest_256(r, g, b) };
}
```

Implement `tui_attrs_to_ncurses` as a `static` function:
- Map TUI_ATTR_BOLD -> A_BOLD, TUI_ATTR_DIM -> A_DIM, TUI_ATTR_UNDERLINE -> A_UNDERLINE, TUI_ATTR_REVERSE -> A_REVERSE
- Use exact implementation from RESEARCH.md

Implement `tui_style_apply`:
```c
void tui_style_apply(WINDOW* win, TUI_Style style) {
    int pair;
    if (style.fg.index == -1 && style.bg.index == -1) {
        pair = 0;  /* Default pair -- no alloc needed */
    } else {
        pair = alloc_pair(style.fg.index, style.bg.index);
    }
    attr_t attrs = tui_attrs_to_ncurses(style.attrs);
    wattr_set(win, attrs, (short)pair, NULL);
}
```

**Update CMakeLists.txt:** Add the new source file to `target_sources`:
```cmake
target_sources(cels-ncurses INTERFACE
    ${CMAKE_CURRENT_SOURCE_DIR}/src/window/tui_window.c
    ${CMAKE_CURRENT_SOURCE_DIR}/src/input/tui_input.c
    ${CMAKE_CURRENT_SOURCE_DIR}/src/renderer/tui_renderer.c
    ${CMAKE_CURRENT_SOURCE_DIR}/src/tui_engine.c
    ${CMAKE_CURRENT_SOURCE_DIR}/src/graphics/tui_color.c
)
```

Also add `-lm` link for math.h usage in later plans. Add it to target_link_libraries:
```cmake
target_link_libraries(cels-ncurses INTERFACE
    ${CURSES_LIBRARIES}
    cels
    m
)
```
  </action>
  <verify>
Compile the implementation file:
```bash
gcc -std=c99 -Wall -Wextra -pedantic -I include $(pkg-config --cflags ncursesw) -c -o /tmp/test_tui_color.o src/graphics/tui_color.c && echo "PASS" || echo "FAIL"
```

Verify RGB mapping produces correct indices for known colors:
- rgb(255, 0, 0) should map to index 196 (bright red in color cube)
- rgb(0, 255, 0) should map to index 46 (bright green)
- rgb(128, 128, 128) should map to greyscale index ~244

Verify CMakeLists.txt contains `tui_color.c` in target_sources and `m` in target_link_libraries.
  </verify>
  <done>
- src/graphics/tui_color.c exists with rgb_to_nearest_256, tui_color_rgb, tui_attrs_to_ncurses, tui_style_apply
- tui_style_apply uses pair 0 for default+default, alloc_pair for everything else
- tui_style_apply uses wattr_set (never attron/attroff)
- CMakeLists.txt includes tui_color.c in INTERFACE sources and links -lm
- Compiles cleanly with C99 -Wall -Wextra -pedantic
  </done>
</task>

</tasks>

<verification>
- `include/cels-ncurses/tui_color.h` defines TUI_Color, TUI_Style, TUI_ATTR_* flags, declares tui_color_rgb and tui_style_apply
- `src/graphics/tui_color.c` implements RGB-to-nearest-256 mapping, tui_color_rgb, and tui_style_apply
- tui_style_apply uses wattr_set exclusively (grep for attron/attroff in the file should find nothing)
- alloc_pair is called only when at least one of fg/bg is not -1
- CMakeLists.txt includes the new source file
- Both files compile cleanly with C99 -Wall -Wextra -pedantic
</verification>

<success_criteria>
The color and style system is complete. Developer can create colors from RGB, build styles with attributes, and apply them atomically to any WINDOW. Color pairs are managed invisibly by ncurses alloc_pair. No hardcoded pair constants, no attron/attroff state management.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
