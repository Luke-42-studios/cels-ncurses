---
phase: 01-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - include/cels-ncurses/tui_draw_context.h
  - src/window/tui_window.c
autonomous: true

must_haves:
  truths:
    - "Developer can create a TUI_DrawContext wrapping a WINDOW* with position, dimensions, and clip rect"
    - "TUI_DrawContext is stack-allocated (value type, no malloc)"
    - "TUI_DrawContext.clip defaults to the full drawable area on creation"
    - "setlocale(LC_ALL, \"\") is called before initscr() so Unicode box-drawing characters render correctly"
    - "use_default_colors() is called after start_color() to enable -1 as default color index"
  artifacts:
    - path: "include/cels-ncurses/tui_draw_context.h"
      provides: "TUI_DrawContext struct definition and tui_draw_context_create function"
      contains: "typedef struct TUI_DrawContext"
    - path: "src/window/tui_window.c"
      provides: "setlocale before initscr, use_default_colors after start_color"
      contains: "setlocale"
  key_links:
    - from: "include/cels-ncurses/tui_draw_context.h"
      to: "include/cels-ncurses/tui_types.h"
      via: "TUI_DrawContext.clip field uses TUI_CellRect"
      pattern: "TUI_CellRect.*clip"
    - from: "include/cels-ncurses/tui_draw_context.h"
      to: "ncurses WINDOW"
      via: "TUI_DrawContext.win borrows WINDOW pointer"
      pattern: "WINDOW\\*.*win"
    - from: "src/window/tui_window.c"
      to: "locale.h"
      via: "setlocale(LC_ALL, \"\") before initscr"
      pattern: "setlocale.*LC_ALL"
---

<objective>
Create the TUI_DrawContext struct (the target for all future draw calls) and add setlocale before initscr in the window startup to enable Unicode box-drawing characters.

Purpose: TUI_DrawContext is the central abstraction that all Phase 2 drawing primitives will take as their first parameter. It wraps a WINDOW* with offset, dimensions, and clip state. The setlocale fix is required before any Unicode rendering can work.

Output: `include/cels-ncurses/tui_draw_context.h` (header-only struct + creation function) and modified `src/window/tui_window.c` (setlocale added).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/codebase/CONVENTIONS.md

# Prior plan artifacts (needed: TUI_CellRect from 01-01, TUI_Style from 01-02)
@include/cels-ncurses/tui_types.h
@include/cels-ncurses/tui_color.h

# File being modified
@src/window/tui_window.c
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tui_draw_context.h with TUI_DrawContext struct and creation function</name>
  <files>include/cels-ncurses/tui_draw_context.h</files>
  <action>
Create `include/cels-ncurses/tui_draw_context.h` with:

**Header documentation block** following project convention:
- Purpose: Draw context wrapping an ncurses WINDOW with position, dimensions, and clipping state
- Note: TUI_DrawContext borrows (does not own) the WINDOW* -- callers manage WINDOW lifetime
- Note: Stack-allocated value type, no malloc/free churn per frame
- Usage example showing tui_draw_context_create and passing to draw functions

**Include guard:** `CELS_NCURSES_TUI_DRAW_CONTEXT_H`

**Includes:** `<ncurses.h>`, `"cels-ncurses/tui_types.h"`

**Section: Draw Context**
```c
typedef struct TUI_DrawContext {
    WINDOW* win;          /* Borrowed -- caller manages lifetime */
    int x, y;             /* Origin offset within the window */
    int width, height;    /* Drawable area dimensions */
    TUI_CellRect clip;    /* Current effective clip rect (set by scissor stack in Phase 2) */
} TUI_DrawContext;
```

**Section: Creation**

`static inline TUI_DrawContext tui_draw_context_create(WINDOW* win, int x, int y, int width, int height)`:
- Set win, x, y, width, height from parameters
- Initialize clip to the full drawable area: `{ .x = x, .y = y, .w = width, .h = height }`
- Return the struct by value (stack allocation)

**Important design notes in comments:**
- All draw functions in Phase 2+ take `TUI_DrawContext*` as their first parameter
- No global "current context" -- caller passes the target explicitly
- The clip field represents the current effective clip rect. Phase 2's scissor stack will update this field.

Use `/* ... */` comments only, 4-space indent, `=` section dividers per project conventions. End with `#endif /* CELS_NCURSES_TUI_DRAW_CONTEXT_H */`.
  </action>
  <verify>
Compile check (depends on tui_types.h from Plan 01-01):
```bash
echo '#include <ncurses.h>
#include "cels-ncurses/tui_draw_context.h"
int main(void) {
    TUI_DrawContext ctx = tui_draw_context_create(stdscr, 0, 0, 80, 24);
    (void)ctx;
    return 0;
}' > /tmp/test_tui_dc.c
gcc -std=c99 -Wall -Wextra -pedantic -I include $(pkg-config --cflags ncursesw) -c -o /tmp/test_tui_dc.o /tmp/test_tui_dc.c && echo "PASS" || echo "FAIL"
```
Verify: ctx.clip should be {0, 0, 80, 24} after creation.
  </verify>
  <done>
- tui_draw_context.h exists with TUI_DrawContext struct (win, x, y, width, height, clip)
- tui_draw_context_create returns a stack-allocated context with clip initialized to full area
- Includes tui_types.h for TUI_CellRect
- Compiles cleanly with C99 -Wall -Wextra -pedantic
  </done>
</task>

<task type="auto">
  <name>Task 2: Add setlocale before initscr in tui_window_startup</name>
  <files>src/window/tui_window.c</files>
  <action>
Modify `src/window/tui_window.c`:

1. **Add include** for `<locale.h>` in the system headers section (after `<stdbool.h>` or similar).

2. **Add setlocale call** in `tui_window_startup()`, BEFORE the `initscr()` call. Insert it as the first ncurses-related line:
```c
static void tui_window_startup(void) {
    signal(SIGINT, tui_sigint_handler);
    atexit(cleanup_endwin);

    /* Enable Unicode box-drawing characters (MUST be before initscr) */
    setlocale(LC_ALL, "");

    /* ncurses initialization */
    initscr();
    /* ... rest unchanged ... */
}
```

3. **Verify use_default_colors() is already called** after start_color(). It is (line 90-91 in existing code: `use_default_colors(); assume_default_colors(-1, -1);`). No change needed here -- just confirm it exists so alloc_pair(-1, x) works correctly with default colors.

Do NOT modify any other part of tui_window.c. The existing color pair init_pair calls (CP_SELECTED etc.) stay -- they are still used by tui_components.h until Phase 5 migration.
  </action>
  <verify>
1. Grep for setlocale in the modified file:
```bash
grep -n "setlocale" src/window/tui_window.c
```
Should show setlocale(LC_ALL, "") BEFORE the line containing initscr().

2. Verify locale.h is included:
```bash
grep -n "locale.h" src/window/tui_window.c
```

3. Verify use_default_colors is still present:
```bash
grep -n "use_default_colors" src/window/tui_window.c
```

4. Compile check:
```bash
gcc -std=c99 -Wall -Wextra -pedantic -I include $(pkg-config --cflags ncursesw) -c -o /tmp/test_tui_window.o src/window/tui_window.c 2>&1 | head -20
```
Note: This may fail due to CELS framework includes not being available in isolation. That is expected. The important check is that locale.h and the setlocale line are syntactically correct -- verify no syntax errors related to the new code.
  </verify>
  <done>
- tui_window.c includes locale.h
- setlocale(LC_ALL, "") is called before initscr() in tui_window_startup
- use_default_colors() is confirmed present after start_color()
- Existing code (init_pair, color setup, frame loop) is unchanged
  </done>
</task>

</tasks>

<verification>
- `include/cels-ncurses/tui_draw_context.h` exists with TUI_DrawContext struct and tui_draw_context_create
- TUI_DrawContext has fields: win (WINDOW*), x, y, width, height, clip (TUI_CellRect)
- tui_draw_context_create initializes clip to full drawable area
- `src/window/tui_window.c` has setlocale(LC_ALL, "") before initscr()
- `src/window/tui_window.c` includes locale.h
- No other changes to tui_window.c beyond the locale additions
</verification>

<success_criteria>
The draw context abstraction is ready for Phase 2 drawing primitives. Any draw function can take TUI_DrawContext* and use ctx->win for ncurses calls, ctx->clip for clipping bounds. Unicode box-drawing characters will render correctly because setlocale is called before ncurses initialization.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
