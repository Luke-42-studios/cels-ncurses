---
phase: 03-layer-system
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - include/cels-ncurses/tui_layer.h
  - src/layer/tui_layer.c
autonomous: true

must_haves:
  truths:
    - "Developer can show/hide a layer (hidden layers excluded from panel compositing)"
    - "Developer can raise a layer to top or lower it to bottom of the z-order stack"
    - "Developer can move a layer to a new screen position via move_panel"
    - "Developer can resize a layer via wresize + replace_panel"
    - "Developer can get a TUI_DrawContext from a layer for drawing with Phase 2 primitives"
  artifacts:
    - path: "include/cels-ncurses/tui_layer.h"
      provides: "Full layer operation API declarations"
      contains: "tui_layer_show"
    - path: "src/layer/tui_layer.c"
      provides: "All layer operation implementations"
      contains: "tui_layer_resize"
  key_links:
    - from: "src/layer/tui_layer.c"
      to: "show_panel/hide_panel"
      via: "ncurses panel visibility API"
      pattern: "show_panel\\|hide_panel"
    - from: "src/layer/tui_layer.c"
      to: "move_panel"
      via: "ncurses panel position API (NOT mvwin)"
      pattern: "move_panel\\(layer->panel"
    - from: "src/layer/tui_layer.c"
      to: "wresize.*replace_panel"
      via: "resize then update panel bookkeeping"
      pattern: "wresize.*replace_panel"
    - from: "src/layer/tui_layer.c"
      to: "tui_draw_context_create"
      via: "bridge from layer to Phase 2 drawing"
      pattern: "tui_draw_context_create\\(layer->win"
---

<objective>
Implement all layer operations (show/hide, raise/lower, move, resize) and the layer-to-DrawContext bridge.

Purpose: Complete the layer API so developers can manipulate layers and draw into them using Phase 2 primitives. After this plan, the full layer API is usable -- only resize handling and frame loop integration remain.

Output: tui_layer.h and tui_layer.c updated with show/hide, raise/lower, move, resize, and get_draw_context functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-layer-system/03-RESEARCH.md
@.planning/phases/03-layer-system/03-01-SUMMARY.md

@include/cels-ncurses/tui_layer.h       -- add declarations here
@src/layer/tui_layer.c                   -- add implementations here
@include/cels-ncurses/tui_draw_context.h -- tui_draw_context_create signature
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement show/hide, raise/lower, and move operations</name>
  <files>include/cels-ncurses/tui_layer.h, src/layer/tui_layer.c</files>
  <action>
  **Add declarations to tui_layer.h** (new section after create/destroy):
  ```c
  /* Show/Hide */
  extern void tui_layer_show(TUI_Layer* layer);
  extern void tui_layer_hide(TUI_Layer* layer);

  /* Z-Order */
  extern void tui_layer_raise(TUI_Layer* layer);
  extern void tui_layer_lower(TUI_Layer* layer);

  /* Move */
  extern void tui_layer_move(TUI_Layer* layer, int x, int y);
  ```

  **Add implementations to tui_layer.c:**

  1. `tui_layer_show`: Early return if `!layer || !layer->panel`. Call `show_panel(layer->panel)`. Set `layer->visible = true`.

  2. `tui_layer_hide`: Early return if `!layer || !layer->panel`. Call `hide_panel(layer->panel)`. Set `layer->visible = false`.

  3. `tui_layer_raise`: Early return if `!layer || !layer->panel`. Call `top_panel(layer->panel)`.

  4. `tui_layer_lower`: Early return if `!layer || !layer->panel`. Call `bottom_panel(layer->panel)`.

  5. `tui_layer_move`: Early return if `!layer || !layer->panel`. Call `move_panel(layer->panel, y, x)` -- note parameter order is (panel, starty, startx). Update `layer->x = x; layer->y = y`.

  IMPORTANT: Use `move_panel()` NOT `mvwin()`. mvwin bypasses panel position tracking and causes visual corruption.
  </action>
  <verify>
  Run: `cd /home/cachy/workspaces/libs/cels && cmake --build build 2>&1 | head -30`
  Build succeeds. Verify: `grep -n "move_panel\|show_panel\|hide_panel\|top_panel\|bottom_panel" modules/cels-ncurses/src/layer/tui_layer.c` shows all five panel API calls.
  </verify>
  <done>
  Show/hide toggles panel visibility. Raise/lower moves panel in z-order stack. Move repositions via move_panel (not mvwin). All functions have null-guard early returns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement resize and layer-to-DrawContext bridge</name>
  <files>include/cels-ncurses/tui_layer.h, src/layer/tui_layer.c</files>
  <action>
  **Add declarations to tui_layer.h:**
  1. Add `#include "cels-ncurses/tui_draw_context.h"` at the top (needed for TUI_DrawContext return type).
  2. Add function declarations:
     ```c
     /* Resize */
     extern void tui_layer_resize(TUI_Layer* layer, int w, int h);

     /* DrawContext Bridge */
     extern TUI_DrawContext tui_layer_get_draw_context(TUI_Layer* layer);
     ```

  **Add implementations to tui_layer.c:**

  1. `tui_layer_resize(TUI_Layer* layer, int w, int h)`:
     - Early return if `!layer || !layer->win || !layer->panel`
     - `wresize(layer->win, h, w)` -- note parameter order: (win, lines, cols)
     - `replace_panel(layer->panel, layer->win)` -- MUST call after wresize even though the window pointer hasn't changed; this updates the panel's internal size bookkeeping
     - Update `layer->width = w; layer->height = h`

  2. `tui_layer_get_draw_context(TUI_Layer* layer)`:
     - Include `cels-ncurses/tui_draw_context.h` in the .c file if not already included via the header
     - Return `tui_draw_context_create(layer->win, 0, 0, layer->width, layer->height)`
     - Coordinates are LOCAL to the layer window: (0,0) is top-left of the layer, not the screen. This is because each panel has its own WINDOW with its own coordinate system.
     - The returned DrawContext borrows the layer's WINDOW (does not own it). The layer manages WINDOW lifetime.
  </action>
  <verify>
  Run: `cd /home/cachy/workspaces/libs/cels && cmake --build build 2>&1 | head -30`
  Build succeeds. Verify: `grep -n "wresize\|replace_panel\|tui_draw_context_create" modules/cels-ncurses/src/layer/tui_layer.c` shows resize sequence and bridge function.
  </verify>
  <done>
  tui_layer_resize calls wresize THEN replace_panel (correct order). tui_layer_get_draw_context returns a DrawContext with local coordinates (0,0 origin). Build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `cd /home/cachy/workspaces/libs/cels && cmake --build build` compiles without errors
2. `grep -c "extern" include/cels-ncurses/tui_layer.h` shows all 8 function declarations (create, destroy, show, hide, raise, lower, move, resize, get_draw_context = 9 total including the 2 from plan 01)
3. No calls to `mvwin` in tui_layer.c (use move_panel only)
4. No calls to `wrefresh` or `wnoutrefresh` in tui_layer.c (panel windows must not be refreshed directly)
5. `replace_panel` appears after `wresize` in tui_layer_resize
</verification>

<success_criteria>
- tui_layer_show/hide use show_panel/hide_panel and track visibility in layer->visible
- tui_layer_raise/lower use top_panel/bottom_panel
- tui_layer_move uses move_panel (NOT mvwin) and updates layer->x, layer->y
- tui_layer_resize calls wresize THEN replace_panel and updates layer->width, layer->height
- tui_layer_get_draw_context returns DrawContext with (0,0) local origin and layer dimensions
- No wrefresh/wnoutrefresh/mvwin calls anywhere in tui_layer.c
- Full project builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/03-layer-system/03-02-SUMMARY.md`
</output>
