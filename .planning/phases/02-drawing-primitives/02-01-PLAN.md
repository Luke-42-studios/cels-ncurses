---
phase: 02-drawing-primitives
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - include/cels-ncurses/tui_draw.h
  - src/graphics/tui_draw.c
  - CMakeLists.txt
autonomous: true

must_haves:
  truths:
    - "Developer can draw a filled rectangle at arbitrary cell position with configurable fill character and style"
    - "Developer can draw an outlined rectangle using box-drawing characters with single, double, or rounded corner styles"
    - "All drawing functions clip against TUI_DrawContext.clip before issuing ncurses calls"
    - "No drawing function calls wrefresh, wnoutrefresh, or doupdate"
  artifacts:
    - path: "include/cels-ncurses/tui_draw.h"
      provides: "TUI_BorderStyle enum, TUI_BorderChars struct, TUI_SIDE_* bitmask defines, all drawing function declarations"
      contains: "typedef enum TUI_BorderStyle"
    - path: "src/graphics/tui_draw.c"
      provides: "tui_draw_fill_rect, tui_draw_border_rect implementations"
      contains: "tui_draw_fill_rect"
    - path: "CMakeLists.txt"
      provides: "tui_draw.c in INTERFACE target_sources"
      contains: "tui_draw.c"
  key_links:
    - from: "src/graphics/tui_draw.c"
      to: "include/cels-ncurses/tui_draw.h"
      via: "includes own header"
      pattern: '#include "cels-ncurses/tui_draw.h"'
    - from: "src/graphics/tui_draw.c"
      to: "tui_cell_rect_intersect"
      via: "clip-then-draw pattern"
      pattern: "tui_cell_rect_intersect"
    - from: "src/graphics/tui_draw.c"
      to: "tui_style_apply"
      via: "style application before drawing"
      pattern: "tui_style_apply"
    - from: "CMakeLists.txt"
      to: "src/graphics/tui_draw.c"
      via: "INTERFACE target_sources"
      pattern: "tui_draw\\.c"
---

<objective>
Create the tui_draw.h header with ALL Phase 2 type declarations and function forward declarations, implement filled and outlined rectangle drawing in tui_draw.c, and register the new source file in CMakeLists.txt.

Purpose: This plan establishes the shared header that all subsequent drawing plans depend on, plus delivers the two rectangle drawing primitives (DRAW-01, DRAW-02, DRAW-06, DRAW-07). By declaring all types and function prototypes upfront, later plans only need to add implementations to tui_draw.c without modifying the header.

Output: tui_draw.h (complete header with all Phase 2 declarations), tui_draw.c (with fill rect and border rect), updated CMakeLists.txt.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-drawing-primitives/02-RESEARCH.md
@.planning/codebase/CONVENTIONS.md
@include/cels-ncurses/tui_types.h
@include/cels-ncurses/tui_color.h
@include/cels-ncurses/tui_draw_context.h
@src/graphics/tui_color.c
@CMakeLists.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tui_draw.h with all Phase 2 type declarations and function prototypes</name>
  <files>include/cels-ncurses/tui_draw.h</files>
  <action>
  Create the header file following the project conventions (file-level doc comment with purpose and usage example, section separators with = dividers, include guard CELS_NCURSES_TUI_DRAW_H, /* */ comments only, 4-space indent).

  Include these headers:
  - "cels-ncurses/tui_types.h"
  - "cels-ncurses/tui_color.h"
  - "cels-ncurses/tui_draw_context.h"
  - <ncurses.h> (for cchar_t, WINDOW)

  Define these types and constants (ALL types for the entire phase, not just this plan):

  1. TUI_BorderStyle enum:
     ```c
     typedef enum TUI_BorderStyle {
         TUI_BORDER_SINGLE,   /* WACS_HLINE / WACS_VLINE / WACS_*CORNER */
         TUI_BORDER_DOUBLE,   /* WACS_D_HLINE / WACS_D_VLINE / WACS_D_*CORNER */
         TUI_BORDER_ROUNDED   /* WACS_HLINE / WACS_VLINE / custom arc corners */
     } TUI_BorderStyle;
     ```

  2. TUI_BorderChars struct:
     ```c
     typedef struct TUI_BorderChars {
         const cchar_t* hline;   /* Horizontal line character */
         const cchar_t* vline;   /* Vertical line character */
         const cchar_t* ul;      /* Upper-left corner */
         const cchar_t* ur;      /* Upper-right corner */
         const cchar_t* ll;      /* Lower-left corner */
         const cchar_t* lr;      /* Lower-right corner */
     } TUI_BorderChars;
     ```

  3. Side bitmask defines:
     ```c
     #define TUI_SIDE_TOP     0x01
     #define TUI_SIDE_RIGHT   0x02
     #define TUI_SIDE_BOTTOM  0x04
     #define TUI_SIDE_LEFT    0x08
     #define TUI_SIDE_ALL     (TUI_SIDE_TOP | TUI_SIDE_RIGHT | TUI_SIDE_BOTTOM | TUI_SIDE_LEFT)
     ```

  Declare ALL Phase 2 drawing function prototypes (extern):

  Rectangle functions (implemented in this plan):
  - `extern void tui_draw_fill_rect(TUI_DrawContext* ctx, TUI_CellRect rect, chtype fill_ch, TUI_Style style);`
  - `extern void tui_draw_border_rect(TUI_DrawContext* ctx, TUI_CellRect rect, TUI_BorderStyle border_style, TUI_Style style);`

  Text functions (implemented in plan 02-02):
  - `extern void tui_draw_text(TUI_DrawContext* ctx, int x, int y, const char* text, TUI_Style style);`
  - `extern void tui_draw_text_bounded(TUI_DrawContext* ctx, int x, int y, const char* text, int max_cols, TUI_Style style);`

  Border function (implemented in plan 02-03):
  - `extern void tui_draw_border(TUI_DrawContext* ctx, TUI_CellRect rect, uint8_t sides, TUI_BorderStyle border_style, TUI_Style style);`

  Line functions (implemented in plan 02-05):
  - `extern void tui_draw_hline(TUI_DrawContext* ctx, int x, int y, int length, TUI_BorderStyle border_style, TUI_Style style);`
  - `extern void tui_draw_vline(TUI_DrawContext* ctx, int x, int y, int length, TUI_BorderStyle border_style, TUI_Style style);`

  Internal helper (used by border/line code, declared extern since it lives in .c):
  - `extern TUI_BorderChars tui_border_chars_get(TUI_BorderStyle border_style);`

  Use separate sections with = dividers for: Types, Constants, Rectangle Drawing, Text Drawing, Border Drawing, Line Drawing.
  </action>
  <verify>
  The file compiles in isolation: check that `#include "cels-ncurses/tui_draw.h"` from a hypothetical .c file would not produce errors. Verify all types referenced (TUI_DrawContext, TUI_CellRect, TUI_Style, chtype, cchar_t) are available through the included headers.
  Verify: No `//` comments, 4-space indent, include guard matches CELS_NCURSES_TUI_DRAW_H.
  </verify>
  <done>
  tui_draw.h exists with TUI_BorderStyle enum (SINGLE/DOUBLE/ROUNDED), TUI_BorderChars struct (6 cchar_t pointers), TUI_SIDE_* bitmask defines (TOP/RIGHT/BOTTOM/LEFT/ALL), and extern declarations for all 8 Phase 2 drawing functions plus the border chars helper.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement filled rect, outlined rect, and border char infrastructure in tui_draw.c</name>
  <files>src/graphics/tui_draw.c, CMakeLists.txt</files>
  <action>
  Create src/graphics/tui_draw.c following conventions: POSIX feature test macros at top, file-level doc comment, own header first, then ncurses, then system headers. Include:
  - `#define _POSIX_C_SOURCE 199309L`
  - `#define _DEFAULT_SOURCE`
  - `#include "cels-ncurses/tui_draw.h"` (brings in tui_types.h, tui_color.h, tui_draw_context.h, ncurses.h)
  - `#include <stdbool.h>` (for bool in rounded corner init flag)
  - `#include <string.h>` (for potential use)

  **Section 1: Rounded Corner cchar_t Initialization**

  Create static cchar_t variables for the 4 rounded corners and a bool init flag:
  ```c
  static cchar_t g_round_ul, g_round_ur, g_round_ll, g_round_lr;
  static bool g_round_corners_initialized = false;
  ```

  Create `static void init_rounded_corners(void)` that:
  - Returns immediately if `g_round_corners_initialized` is true
  - Uses `setcchar()` to create each rounded corner cchar_t:
    - g_round_ul: wchar_t 0x256D (BOX DRAWINGS LIGHT ARC DOWN AND RIGHT)
    - g_round_ur: wchar_t 0x256E (BOX DRAWINGS LIGHT ARC DOWN AND LEFT)
    - g_round_lr: wchar_t 0x256F (BOX DRAWINGS LIGHT ARC UP AND LEFT)
    - g_round_ll: wchar_t 0x2570 (BOX DRAWINGS LIGHT ARC UP AND RIGHT)
  - Each setcchar call uses: `wchar_t wc[2] = { 0xNNNN, L'\0' };` then `setcchar(&var, wc, A_NORMAL, 0, NULL);`
  - Sets `g_round_corners_initialized = true;`

  **Section 2: Border Character Lookup**

  Implement `TUI_BorderChars tui_border_chars_get(TUI_BorderStyle border_style)`:
  - For TUI_BORDER_SINGLE: return struct with WACS_HLINE, WACS_VLINE, WACS_ULCORNER, WACS_URCORNER, WACS_LLCORNER, WACS_LRCORNER
  - For TUI_BORDER_DOUBLE: return struct with WACS_D_HLINE, WACS_D_VLINE, WACS_D_ULCORNER, WACS_D_URCORNER, WACS_D_LLCORNER, WACS_D_LRCORNER
  - For TUI_BORDER_ROUNDED: call `init_rounded_corners()`, return struct with WACS_HLINE, WACS_VLINE, &g_round_ul, &g_round_ur, &g_round_ll, &g_round_lr
  - Default: fall through to TUI_BORDER_SINGLE

  Use a switch statement. The WACS_* macros ARE already pointers to cchar_t, so assign them directly to the const cchar_t* fields. The rounded corner globals need & operator since they are cchar_t values (not pointers).

  **Section 3: Filled Rectangle (DRAW-01)**

  Implement `tui_draw_fill_rect`:
  - Intersect `rect` with `ctx->clip` using `tui_cell_rect_intersect()` to get `visible`
  - If `visible.w <= 0 || visible.h <= 0`, return immediately (fully clipped)
  - Call `tui_style_apply(ctx->win, style)`
  - Double loop: for each row in [visible.y, visible.y+visible.h), for each col in [visible.x, visible.x+visible.w), call `mvwaddch(ctx->win, row, col, fill_ch)`
  - No wrefresh/wnoutrefresh/doupdate calls

  **Section 4: Outlined Rectangle (DRAW-02, DRAW-06, DRAW-07)**

  Implement `tui_draw_border_rect`:
  - Get border characters via `tui_border_chars_get(border_style)`
  - Call `tui_style_apply(ctx->win, style)`
  - The rectangle needs at least 2x2 to draw a border (if rect.w < 2 || rect.h < 2, return)
  - For each component, check if the cell is within `ctx->clip` using `tui_cell_rect_contains()` before drawing:
    - Four corners: Use `mvwadd_wch(ctx->win, y, x, chars.ul/ur/ll/lr)` at the corner positions. Check `tui_cell_rect_contains(ctx->clip, col, row)` before each.
    - Top edge: For col from rect.x+1 to rect.x+rect.w-2, if `tui_cell_rect_contains(ctx->clip, col, rect.y)`, draw `mvwadd_wch(ctx->win, rect.y, col, chars.hline)`
    - Bottom edge: Same pattern at rect.y+rect.h-1
    - Left edge: For row from rect.y+1 to rect.y+rect.h-2, if `tui_cell_rect_contains(ctx->clip, rect.x, row)`, draw `mvwadd_wch(ctx->win, row, rect.x, chars.vline)`
    - Right edge: Same pattern at rect.x+rect.w-1
  - No wrefresh/wnoutrefresh/doupdate calls

  **CMakeLists.txt update:**

  Add `${CMAKE_CURRENT_SOURCE_DIR}/src/graphics/tui_draw.c` to the target_sources list, after the existing tui_color.c entry.
  </action>
  <verify>
  1. Build the project: `cmake --build build` from the project root (or parent that includes this module). Verify no compilation errors or warnings.
  2. Grep for anti-patterns: `grep -n 'wrefresh\|wnoutrefresh\|doupdate' src/graphics/tui_draw.c` should return no matches.
  3. Grep for correct includes: `grep -n '#include' src/graphics/tui_draw.c` shows own header first.
  4. Verify CMakeLists.txt contains tui_draw.c: `grep 'tui_draw.c' CMakeLists.txt`
  </verify>
  <done>
  tui_draw.c implements tui_draw_fill_rect (cell-by-cell fill with clip), tui_draw_border_rect (outlined rect with WACS_ macros for single/double and setcchar for rounded corners), and tui_border_chars_get (border style lookup table). CMakeLists.txt includes tui_draw.c in INTERFACE sources. No refresh calls in any draw function.
  </done>
</task>

</tasks>

<verification>
- `include/cels-ncurses/tui_draw.h` exists with TUI_BorderStyle, TUI_BorderChars, TUI_SIDE_* defines, and all 8 drawing function declarations
- `src/graphics/tui_draw.c` exists with fill rect, border rect, and border char infrastructure
- `CMakeLists.txt` lists tui_draw.c in target_sources
- No `wrefresh`, `wnoutrefresh`, or `doupdate` calls in tui_draw.c
- Code follows project conventions: C99, /* */ comments, 4-space indent, section separators
- Build succeeds with no errors (note: unresolved extern symbols for not-yet-implemented functions are expected since this is an INTERFACE library -- they only error at link time in the consumer)
</verification>

<success_criteria>
Developer can call tui_draw_fill_rect to draw a filled rectangle with any chtype character and style, clipped to the draw context. Developer can call tui_draw_border_rect to draw an outlined rectangle with single, double, or rounded box-drawing characters, clipped to the draw context. The tui_draw.h header declares all Phase 2 types and function prototypes for use by subsequent plans.
</success_criteria>

<output>
After completion, create `.planning/phases/02-drawing-primitives/02-01-SUMMARY.md`
</output>
