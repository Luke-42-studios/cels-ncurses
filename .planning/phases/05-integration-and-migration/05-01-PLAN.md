---
phase: 05-integration-and-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - examples/widgets/theme.h
  - examples/widgets/canvas.h
  - examples/widgets/button.h
  - examples/widgets/slider.h
  - examples/widgets/hint.h
  - examples/widgets/info_box.h
  - examples/render_provider.h
  - examples/app.c
  - examples/components.h
autonomous: true

must_haves:
  truths:
    - "Example app has widget render functions that use tui_draw_text/tui_draw_border_rect/tui_draw_fill_rect via DrawContext"
    - "Example app registers its own CELS render provider that draws via the background layer DrawContext"
    - "Theme styles are initialized at runtime via theme_init() called from the render callback"
    - "Widget render functions take explicit (x, y) coordinates and DrawContext pointer -- no g_render_row global"
  artifacts:
    - path: "examples/widgets/theme.h"
      provides: "Semantic TUI_Style constants (highlight, active, inactive, muted, accent, normal)"
      contains: "theme_init"
    - path: "examples/widgets/canvas.h"
      provides: "Canvas header widget using tui_draw_border_rect and tui_draw_text"
      contains: "widget_canvas_render"
    - path: "examples/widgets/button.h"
      provides: "Button widget using tui_draw_text"
      contains: "widget_button_render"
    - path: "examples/widgets/slider.h"
      provides: "Cycle slider and toggle slider widgets using tui_draw_text"
      contains: "widget_slider_cycle_render"
    - path: "examples/widgets/hint.h"
      provides: "Hint text widget using tui_draw_text"
      contains: "widget_hint_render"
    - path: "examples/widgets/info_box.h"
      provides: "Info box widget using tui_draw_border_rect and tui_draw_text"
      contains: "widget_info_box_render"
    - path: "examples/render_provider.h"
      provides: "App-level CELS Renderable feature + provider registration"
      contains: "app_renderer_init"
    - path: "examples/app.c"
      provides: "Updated entry point calling app_renderer_init() after TUI_Engine_use()"
      contains: "app_renderer_init"
  key_links:
    - from: "examples/render_provider.h"
      to: "tui_frame_get_background / tui_layer_get_draw_context"
      via: "DrawContext from background layer"
      pattern: "tui_frame_get_background.*tui_layer_get_draw_context"
    - from: "examples/widgets/*.h"
      to: "tui_draw_text / tui_draw_border_rect"
      via: "DrawContext pointer parameter"
      pattern: "tui_draw_text\\(ctx"
    - from: "examples/app.c"
      to: "examples/render_provider.h"
      via: "#include and app_renderer_init() call"
      pattern: "app_renderer_init"
---

<objective>
Create all example app widget files rewritten to use the Phase 1-4 graphics API (DrawContext, TUI_Style, tui_draw_* primitives), and wire an app-level render provider into the example app.

Purpose: This replaces the legacy mvprintw/attron/attroff widget code with the new graphics API. The app must have working replacement code BEFORE the module's old files are removed in Plan 02.

Output: 7 new header files in examples/ (6 widgets + 1 render provider), updated app.c with app_renderer_init() call.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-integration-and-migration/05-CONTEXT.md
@.planning/phases/05-integration-and-migration/05-RESEARCH.md

Source files to reference (the old code being replaced):
@include/cels-ncurses/tui_components.h
@src/renderer/tui_renderer.c

API headers to use (the new drawing API):
@include/cels-ncurses/tui_draw.h
@include/cels-ncurses/tui_color.h
@include/cels-ncurses/tui_frame.h
@include/cels-ncurses/tui_layer.h

Consumer app files being modified:
@examples/app.c (in parent cels repo: /home/cachy/workspaces/libs/cels/examples/app.c)
@examples/components.h (in parent cels repo: /home/cachy/workspaces/libs/cels/examples/components.h)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create widget header files and theme</name>
  <files>
    /home/cachy/workspaces/libs/cels/examples/widgets/theme.h
    /home/cachy/workspaces/libs/cels/examples/widgets/canvas.h
    /home/cachy/workspaces/libs/cels/examples/widgets/button.h
    /home/cachy/workspaces/libs/cels/examples/widgets/slider.h
    /home/cachy/workspaces/libs/cels/examples/widgets/hint.h
    /home/cachy/workspaces/libs/cels/examples/widgets/info_box.h
  </files>
  <action>
    Create `examples/widgets/` directory in the parent cels repo (/home/cachy/workspaces/libs/cels/examples/widgets/).

    **theme.h**: Define semantic TUI_Style constants. Use a `theme_init()` function (NOT compile-time constants -- tui_color_rgb() is a runtime function). Include `<cels-ncurses/tui_color.h>`. Define static TUI_Style variables: theme_highlight (yellow-ish, bold), theme_active (green, bold), theme_inactive (red, bold), theme_muted (default fg, dim), theme_accent (cyan, bold), theme_normal (white, no attrs). Use a static bool to guard against double-init. Map colors from the old CP_* constants:
    - CP_SELECTED (yellow) -> theme_highlight: tui_color_rgb(255, 255, 0) with TUI_ATTR_BOLD
    - CP_HEADER (cyan) -> theme_accent: tui_color_rgb(0, 255, 255) with TUI_ATTR_BOLD
    - CP_ON (green) -> theme_active: tui_color_rgb(0, 255, 0) with TUI_ATTR_BOLD
    - CP_OFF (red) -> theme_inactive: tui_color_rgb(255, 0, 0) with TUI_ATTR_BOLD
    - CP_NORMAL (white) -> theme_normal: tui_color_rgb(255, 255, 255) with TUI_ATTR_NORMAL (A_BOLD was used with CP_NORMAL in the old code for bright white -- decide per widget whether bold is needed)
    - CP_DIM (default + A_DIM) -> theme_muted: TUI_COLOR_DEFAULT fg/bg with TUI_ATTR_DIM

    **canvas.h**: Port tui_render_canvas() from tui_components.h. Signature: `widget_canvas_render(TUI_DrawContext* ctx, int x, int y, const char* title)`. Use tui_draw_border_rect() for the box (TUI_BORDER_SINGLE, width 43, height 3). Use tui_draw_text() for centered title with theme_accent style. Include `<cels-ncurses/tui_draw.h>` and `"theme.h"`.

    **button.h**: Port tui_render_button(). Signature: `widget_button_render(TUI_DrawContext* ctx, int x, int y, const char* label, bool selected)`. Selected state: format "> label <" string with theme_highlight. Unselected: just the label at x+2 with theme_muted (matching old behavior where unselected had no color). Include `<cels-ncurses/tui_draw.h>`, `"theme.h"`, `<string.h>`, `<stdio.h>`.

    **slider.h**: Port both tui_render_slider_cycle() and tui_render_slider_toggle(). Two functions:
    - `widget_slider_cycle_render(TUI_DrawContext* ctx, int x, int y, const char* label, const char* value, bool selected)` -- Render label, [<] value [>] pattern. Selected: label in theme_highlight, arrows in theme_accent, value in theme_normal with bold. Unselected: label plain, arrows dim, value in theme_normal with bold.
    - `widget_slider_toggle_render(TUI_DrawContext* ctx, int x, int y, const char* label, bool value, bool selected)` -- Render label, then ON/OFF toggle. ON state: dim "[ OFF ]" + green "[= ON =]". OFF state: red "[= OFF =]" + dim "[ ON ]".
    Build display strings with snprintf and draw with tui_draw_text(). Include `<cels-ncurses/tui_draw.h>`, `"theme.h"`, `<stdio.h>`, `<string.h>`.

    **hint.h**: Port tui_render_hint(). Signature: `widget_hint_render(TUI_DrawContext* ctx, int x, int y, const char* text)`. Draw text with theme_muted (dim) style. Simple one-liner using tui_draw_text().

    **info_box.h**: Port tui_render_info_box(). Signature: `widget_info_box_render(TUI_DrawContext* ctx, int x, int y, const char* title, const char* version)`. Use tui_draw_border_rect() for box (TUI_BORDER_SINGLE, width 43, height 3). Draw "Title: " + title + "Version: " + version inside the box using tui_draw_text() calls with theme_muted for labels and theme_accent/theme_normal for values.

    All widget files are header-only (static inline functions). All include appropriate include guards. Each widget includes `<cels-ncurses/tui_draw.h>` (which transitively includes tui_types.h, tui_color.h, tui_draw_context.h).
  </action>
  <verify>
    All 6 files exist under /home/cachy/workspaces/libs/cels/examples/widgets/. Each file has include guards, includes `<cels-ncurses/tui_draw.h>`, and contains at least one `static inline void widget_*` function that takes `TUI_DrawContext* ctx` as first parameter. No file contains mvprintw, attron, attroff, or COLOR_PAIR.
  </verify>
  <done>
    6 widget header files created with DrawContext-based rendering functions matching the visual behavior of the old tui_components.h widgets.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create render provider and wire into app.c</name>
  <files>
    /home/cachy/workspaces/libs/cels/examples/render_provider.h
    /home/cachy/workspaces/libs/cels/examples/app.c
    /home/cachy/workspaces/libs/cels/examples/components.h
  </files>
  <action>
    **render_provider.h**: Create an app-level render provider that replaces the module's tui_renderer.c. This file is the key migration piece. Structure:

    1. Include guards and includes: `<cels/cels.h>`, `<cels-ncurses/tui_frame.h>`, `<cels-ncurses/tui_layer.h>`, `<cels-ncurses/tui_draw.h>`, `<cels-ncurses/tui_window.h>`, `<flecs.h>`, `"components.h"`, all widget headers from `"widgets/theme.h"` through `"widgets/info_box.h"`.

    2. `_CEL_DefineFeature(Renderable, .phase = CELS_Phase_OnStore, .priority = 0);` -- identical to old tui_renderer.c.

    3. Keep the RESOLUTIONS[] array and get_setting_bool() helper (copied from tui_renderer.c -- these are app-specific data).

    4. Keep the find_graphics_settings() helper. NOTE: this function already exists in app.c AND in tui_renderer.c (duplicate). The render_provider.h version is the only one needed -- remove the duplicate from app.c if it exists there.

    5. `app_render_screen(CELS_Iter* it)` callback -- port from tui_prov_render_screen() in tui_renderer.c with these changes:
       - Call `theme_init()` (idempotent via static bool guard) at the top of the function on first invocation.
       - Get background layer: `TUI_Layer* bg = tui_frame_get_background(); if (!bg) return;`
       - Get DrawContext: `TUI_DrawContext ctx = tui_layer_get_draw_context(bg);`
       - **Remove**: werase(stdscr), overwrite(stdscr, bg->win) -- these are the stdscr bridge being deleted.
       - **Remove**: tui_render_reset_row() -- no more g_render_row tracking.
       - Replace all tui_render_* calls with widget_*_render calls passing `&ctx` and explicit (x, y) coordinates.
       - Layout: compute y positions manually. Start canvas at y=1, then widgets below the canvas (y=5 after 3-row canvas + 1 blank). Increment y for each widget.
       - Keep the change-detection optimization (last_selected, last_screen, etc.) -- it works fine, just drives the redraw decision.

    6. `app_renderer_init()` function -- identical to old tui_renderer_init():
       ```c
       static inline void app_renderer_init(void) {
           _CEL_Feature(Canvas, Renderable);
           _CEL_Provides(TUI, Renderable, Canvas, app_render_screen);
           _CEL_ProviderConsumes(Text, ClickArea, Selectable, Range, GraphicsSettings);
       }
       ```

    **app.c modifications** (file is at /home/cachy/workspaces/libs/cels/examples/app.c):
    - Add `#include "render_provider.h"` after `#include "components.h"`.
    - In CEL_Build(App), add `app_renderer_init();` AFTER the TUI_Engine_use() call but BEFORE InitConfig(). This is critical -- CELS macros require the ECS world from TUI_Engine_use() to be initialized first.
    - Remove the duplicate `find_graphics_settings()` function from app.c (it exists at line ~72, but render_provider.h also has one). If the app.c version is still needed by input systems, keep it -- but check whether both are needed. If both app.c and render_provider.h define it as static, that's fine (different TUs... but this is a single TU since it's all headers included into app.c). So the duplicate would cause a "defined but not used" warning or redefinition error. Resolution: remove the one from app.c and keep the one in render_provider.h -- the input systems in app.c can use it since render_provider.h is included.

    **components.h modifications** (file is at /home/cachy/workspaces/libs/cels/examples/components.h):
    - Remove the comment at the bottom that references tui_renderer.h: `/* No TUI provider declarations here -- providers are in cels-ncurses module. Include <cels-ncurses/tui_renderer.h> for tui_renderer_init(). */`
    - Replace with: `/* Renderer provider is app-level -- see render_provider.h */`

    **Important ordering note**: After this plan, both the old module renderer AND the new app renderer will be registered. This is temporary -- the module's tui_renderer_init() will be removed in Plan 02. The app should still compile and run (the last-registered provider wins, or both run -- either way, Plan 02 cleans this up).
  </action>
  <verify>
    Build the app target from the parent cels repo:
    ```
    cd /home/cachy/workspaces/libs/cels && cmake --build build 2>&1
    ```
    The `app` target compiles without errors. The render_provider.h file exists and contains app_renderer_init(). The app.c file includes render_provider.h and calls app_renderer_init() in CEL_Build.
  </verify>
  <done>
    render_provider.h created with app-level Renderable provider using DrawContext API. app.c updated to call app_renderer_init() after TUI_Engine_use(). App compiles successfully with both old and new renderers temporarily coexisting.
  </done>
</task>

</tasks>

<verification>
1. All 7 new files exist under /home/cachy/workspaces/libs/cels/examples/ (6 widget headers + render_provider.h)
2. `cd /home/cachy/workspaces/libs/cels && cmake --build build` succeeds with zero errors on the `app` target
3. No widget file contains mvprintw, attron, attroff, or COLOR_PAIR
4. Every widget function takes TUI_DrawContext* as first parameter
5. render_provider.h contains _CEL_DefineFeature, _CEL_Provides, and _CEL_ProviderConsumes calls
6. app.c calls app_renderer_init() after TUI_Engine_use()
</verification>

<success_criteria>
- 7 new header files created in examples/ with DrawContext-based rendering
- App target compiles cleanly
- Widget render functions match the visual layout of the old tui_components.h widgets
- App-level render provider registered correctly via CELS macros
</success_criteria>

<output>
After completion, create `.planning/phases/05-integration-and-migration/05-01-SUMMARY.md`
</output>
