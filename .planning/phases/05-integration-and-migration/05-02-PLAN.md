---
phase: 05-integration-and-migration
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/tui_engine.c
  - include/cels-ncurses/tui_engine.h
  - src/window/tui_window.c
  - CMakeLists.txt
  - include/cels-ncurses/tui_renderer.h
  - include/cels-ncurses/tui_components.h
  - src/renderer/tui_renderer.c
autonomous: true

must_haves:
  truths:
    - "tui_renderer_init() is no longer called by TUI_Engine -- the module has no app-specific render provider"
    - "tui_renderer.h, tui_components.h, and tui_renderer.c do not exist in the module"
    - "No init_pair() calls remain in the module -- all color pairs come from alloc_pair via tui_color_rgb()"
    - "No overwrite(stdscr, ...) bridge code remains anywhere -- widgets draw directly to layer DrawContext"
    - "App builds and runs using only the new graphics API -- no stdscr drawing after initialization"
    - "CMakeLists.txt no longer references tui_renderer.c"
  artifacts:
    - path: "src/tui_engine.c"
      provides: "Module init without tui_renderer_init() call"
      contains: "tui_frame_init"
    - path: "include/cels-ncurses/tui_engine.h"
      provides: "Engine header without tui_renderer.h include"
      contains: "tui_frame.h"
    - path: "src/window/tui_window.c"
      provides: "Window startup without init_pair() calls"
      contains: "start_color"
    - path: "CMakeLists.txt"
      provides: "Build config without tui_renderer.c source"
      contains: "tui_frame.c"
  key_links:
    - from: "src/tui_engine.c"
      to: "tui_frame_init / tui_frame_register_systems"
      via: "Direct function calls (renderer init removed)"
      pattern: "tui_frame_init.*tui_frame_register_systems"
    - from: "include/cels-ncurses/tui_engine.h"
      to: "tui_window.h, tui_input.h, tui_frame.h"
      via: "#include directives (tui_renderer.h removed)"
      pattern: "tui_frame\\.h"
---

<objective>
Strip the cels-ncurses module of all app-specific code: remove the renderer provider, delete legacy headers, remove init_pair() calls, and remove the overwrite(stdscr) bridge. The module becomes a pure graphics backend.

Purpose: Completes the module boundary enforcement (MIGR-01 through MIGR-05). After this plan, the module contains only: window management, input, frame pipeline, layers, drawing primitives, color system. All rendering is owned by the example app.

Output: 3 files deleted from module, 4 files modified in module, clean build.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-integration-and-migration/05-CONTEXT.md
@.planning/phases/05-integration-and-migration/05-RESEARCH.md
@.planning/phases/05-integration-and-migration/05-01-SUMMARY.md

Module files being modified:
@src/tui_engine.c
@include/cels-ncurses/tui_engine.h
@src/window/tui_window.c
@CMakeLists.txt

Module files being deleted:
@include/cels-ncurses/tui_renderer.h
@include/cels-ncurses/tui_components.h
@src/renderer/tui_renderer.c
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove renderer from engine and delete module files</name>
  <files>
    /home/cachy/workspaces/libs/cels/modules/cels-ncurses/src/tui_engine.c
    /home/cachy/workspaces/libs/cels/modules/cels-ncurses/include/cels-ncurses/tui_engine.h
    /home/cachy/workspaces/libs/cels/modules/cels-ncurses/CMakeLists.txt
    /home/cachy/workspaces/libs/cels/modules/cels-ncurses/include/cels-ncurses/tui_renderer.h
    /home/cachy/workspaces/libs/cels/modules/cels-ncurses/include/cels-ncurses/tui_components.h
    /home/cachy/workspaces/libs/cels/modules/cels-ncurses/src/renderer/tui_renderer.c
  </files>
  <action>
    **tui_engine.c** modifications:
    1. Remove `#include "cels-ncurses/tui_renderer.h"` (line 17 area -- it's included implicitly via tui_engine.h, but check).
    2. Remove the `tui_renderer_init();` call from inside _CEL_DefineModule(TUI_Engine) (line 35). Keep tui_frame_init() and tui_frame_register_systems() -- those stay.
    3. Update the file-level comment to remove "Renderer" from the provider list. Change "Registers all TUI providers (Window, Input, Renderer)" to "Registers TUI providers (Window, Input) and initializes the frame pipeline".

    **tui_engine.h** modifications:
    1. Remove `#include <cels-ncurses/tui_renderer.h>` (line 45).
    2. Update the file-level comment block to remove references to tui_renderer.h and tui_renderer_init(). The "Before:" example should no longer show the renderer include/init. The "After:" example stays the same since TUI_Engine_use() is unchanged.
    3. Update the "Bundles all TUI providers (Window, Input, Renderer)" comment to "Bundles TUI providers (Window, Input) and frame pipeline".

    **CMakeLists.txt** modifications:
    1. Remove `${CMAKE_CURRENT_SOURCE_DIR}/src/renderer/tui_renderer.c` from target_sources(cels-ncurses INTERFACE ...).
    2. Update the comment at the top if it mentions "Renderer" in the provider list.

    **Delete files** (use git rm for clean tracking):
    1. `git rm include/cels-ncurses/tui_renderer.h`
    2. `git rm include/cels-ncurses/tui_components.h`
    3. `git rm src/renderer/tui_renderer.c`
    4. Remove the now-empty `src/renderer/` directory if git rm leaves it.

    These 3 deletions must happen AFTER the engine modifications (or in the same commit), because removing the files while tui_engine.h still includes tui_renderer.h would break the build.

    Order: Modify tui_engine.h (remove include) -> Modify tui_engine.c (remove init call) -> Modify CMakeLists.txt (remove source) -> Delete files.
  </action>
  <verify>
    Deleted files no longer exist:
    ```
    test ! -f include/cels-ncurses/tui_renderer.h && test ! -f include/cels-ncurses/tui_components.h && test ! -f src/renderer/tui_renderer.c && echo "OK: files deleted"
    ```
    tui_engine.h does not contain "tui_renderer":
    ```
    ! grep -q "tui_renderer" include/cels-ncurses/tui_engine.h && echo "OK: no renderer ref in engine header"
    ```
    CMakeLists.txt does not reference tui_renderer.c:
    ```
    ! grep -q "tui_renderer" CMakeLists.txt && echo "OK: no renderer in CMake"
    ```
  </verify>
  <done>
    tui_renderer_init() removed from engine. tui_renderer.h, tui_components.h, and tui_renderer.c deleted. CMakeLists.txt updated. No remaining references to tui_renderer in the module's engine code.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove init_pair calls, verify build, add stdscr invariant</name>
  <files>
    /home/cachy/workspaces/libs/cels/modules/cels-ncurses/src/window/tui_window.c
  </files>
  <action>
    **tui_window.c** modifications:
    1. Remove the 6 init_pair() calls (lines 95-100) from tui_window_startup(). These are:
       ```c
       init_pair(1, COLOR_YELLOW, -1);
       init_pair(2, COLOR_CYAN, -1);
       init_pair(3, COLOR_GREEN, -1);
       init_pair(4, COLOR_RED, -1);
       init_pair(5, COLOR_WHITE, -1);
       init_pair(6, -1, -1);
       ```
       Keep has_colors(), start_color(), use_default_colors(), assume_default_colors() -- those are still needed for the alloc_pair system to work.
    2. Remove the comment "Color pairs for TUI widgets" above the deleted lines.
    3. Update the file-level comment to remove "Color pair setup for TUI widgets" from the Responsibilities list.
    4. Add an invariant comment after the color setup block:
       ```c
       /* INVARIANT: No code in this module calls mvprintw(), printw(),
        * addstr(), addch(), or any ncurses function that implicitly targets
        * stdscr for drawing. All drawing goes through TUI_DrawContext via
        * tui_draw_* functions. stdscr is retained only for input:
        * keypad(stdscr), nodelay(stdscr), wgetch(stdscr).
        * Violation check: grep -rn 'mvprintw\|printw\|addstr\|addch' src/ */
       ```

    **Build verification**: After all modifications, build the entire project:
    ```
    cd /home/cachy/workspaces/libs/cels && cmake --build build 2>&1
    ```
    The `app` target must compile and link without errors.

    **Static analysis**: Verify no stdscr drawing functions remain in the module source:
    ```
    grep -rn 'mvprintw\|printw\|mvaddstr\|addstr\|mvaddch\|addch\|overwrite' src/ include/
    ```
    This should return zero hits (excluding comments). If any hits are found, they are bugs to fix.
  </action>
  <verify>
    Build succeeds:
    ```
    cd /home/cachy/workspaces/libs/cels && cmake --build build 2>&1 | tail -5
    ```
    No init_pair calls remain:
    ```
    ! grep -q "init_pair" src/window/tui_window.c && echo "OK: no init_pair"
    ```
    No stdscr drawing functions in module source (excluding comments and input code):
    ```
    grep -rn 'mvprintw\|printw\|mvaddstr\|addstr\|mvaddch\|addch' src/ | grep -v '//' | grep -v '*' | wc -l
    ```
    Should be 0.
  </verify>
  <done>
    init_pair() calls removed from tui_window.c. stdscr invariant comment added. Full build succeeds. No stdscr drawing functions remain in module source code. Module is a pure graphics backend with no app-specific code.
  </done>
</task>

</tasks>

<verification>
1. `cd /home/cachy/workspaces/libs/cels && cmake --build build` succeeds (zero errors, zero warnings from module files)
2. Files deleted: tui_renderer.h, tui_components.h, tui_renderer.c do not exist
3. No `init_pair` in tui_window.c
4. No `tui_renderer` references in tui_engine.h or tui_engine.c
5. No `mvprintw|printw|addstr|addch|overwrite` in module src/ directory (excluding comments)
6. CMakeLists.txt does not reference tui_renderer.c
7. tui_window.c contains the stdscr invariant comment
</verification>

<success_criteria>
- Module contains zero app-specific code (no widgets, no render provider, no color constants)
- tui_renderer.c, tui_renderer.h, tui_components.h deleted
- init_pair() calls removed from tui_window.c
- App target builds and links successfully against the stripped module
- MIGR-01 through MIGR-05 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/05-integration-and-migration/05-02-SUMMARY.md`
</output>
